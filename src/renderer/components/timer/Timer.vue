<template>
  <div class="Timer-wrapper">
    <app-audio/>
    <app-timer-dial :minutes="minutes">
      <p class="Dial-time" v-if="!timerStarted">{{ prettyMinutes }}</p>
      <p class="Dial-time" v-else>{{ prettyTime }}</p>
    </app-timer-dial>

    <section class="Container Button-wrapper">
      <transition name="fade" mode="out-in">
        <div class="Button" v-if="!timerStarted" @click="startTimer" :key="'start'">
          <div class="Button-icon-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="isolation:isolate" viewBox="612.399 455.78 58 58" width="58" height="58"><path d=" M 641.399 455.78 C 625.411 455.78 612.399 468.792 612.399 484.78 C 612.399 500.768 625.411 513.78 641.399 513.78 C 657.387 513.78 670.399 500.768 670.399 484.78 C 670.399 468.792 657.387 455.78 641.399 455.78 Z  M 641.399 457.78 C 656.286 457.78 668.399 469.893 668.399 484.78 C 668.399 499.667 656.286 511.78 641.399 511.78 C 626.512 511.78 614.399 499.667 614.399 484.78 C 614.399 469.893 626.512 457.78 641.399 457.78 Z  M 640.961 461.788 C 635.071 461.908 629.36 464.288 625.133 468.514 C 616.169 477.484 616.169 492.073 625.133 501.042 C 625.321 501.231 625.576 501.337 625.842 501.337 C 626.108 501.337 626.363 501.231 626.551 501.042 C 626.942 500.651 626.942 500.018 626.551 499.628 C 618.36 491.44 618.364 478.12 626.551 469.932 C 631.323 465.173 638.084 462.985 644.739 464.046 C 645.285 464.133 645.798 463.761 645.886 463.215 C 645.973 462.669 645.601 462.156 645.055 462.069 C 643.702 461.853 642.332 461.759 640.962 461.788 L 640.961 461.788 Z  M 649.059 463.167 C 648.658 463.183 648.306 463.439 648.165 463.815 C 648.071 464.064 648.08 464.34 648.19 464.582 C 648.3 464.824 648.502 465.012 648.751 465.105 C 649.461 465.37 650.165 465.675 650.852 466.018 C 650.991 466.09 651.145 466.128 651.302 466.128 C 651.665 466.128 652.016 465.928 652.196 465.577 C 652.441 465.083 652.243 464.483 651.751 464.233 C 651.002 463.857 650.234 463.52 649.45 463.225 C 649.325 463.181 649.193 463.161 649.06 463.167 L 649.059 463.167 Z  M 654.833 466.456 C 654.431 466.502 654.096 466.787 653.988 467.178 C 653.879 467.568 654.017 467.985 654.337 468.233 C 655.008 468.76 655.646 469.327 656.247 469.933 C 664.438 478.12 664.438 491.44 656.247 499.628 C 655.856 500.02 655.856 500.654 656.247 501.046 C 656.442 501.237 656.7 501.339 656.957 501.339 C 657.212 501.339 657.469 501.237 657.665 501.046 C 666.629 492.076 666.629 477.483 657.665 468.514 C 657.004 467.856 656.304 467.236 655.571 466.659 C 655.361 466.497 655.096 466.424 654.833 466.456 Z  M 636.383 473.542 C 636.029 473.538 635.679 473.63 635.372 473.807 C 634.742 474.158 634.354 474.825 634.36 475.546 L 634.36 494.014 C 634.36 494.744 634.739 495.397 635.372 495.757 C 635.999 496.112 636.769 496.103 637.387 495.733 L 652.809 486.5 C 653.419 486.133 653.786 485.492 653.786 484.781 C 653.786 484.074 653.419 483.429 652.809 483.062 L 637.387 473.828 C 637.083 473.647 636.737 473.548 636.383 473.543 L 636.383 473.542 Z  M 636.363 475.546 L 651.787 484.78 L 636.365 494.018 L 636.363 475.546 Z  M 631.774 501.175 C 631.376 501.124 630.985 501.318 630.786 501.667 L 629.786 503.397 C 629.653 503.626 629.616 503.899 629.684 504.156 C 629.753 504.412 629.92 504.631 630.149 504.764 C 630.627 505.038 631.237 504.874 631.512 504.397 L 632.512 502.667 C 632.681 502.377 632.693 502.023 632.544 501.723 C 632.396 501.422 632.106 501.217 631.774 501.175 Z  M 651.024 501.175 C 650.692 501.218 650.403 501.425 650.255 501.725 C 650.106 502.026 650.118 502.381 650.286 502.671 L 651.286 504.401 C 651.418 504.63 651.636 504.797 651.892 504.866 C 652.148 504.934 652.42 504.897 652.649 504.764 C 652.879 504.632 653.046 504.414 653.114 504.158 C 653.182 503.902 653.146 503.629 653.012 503.401 L 652.012 501.671 C 651.812 501.322 651.423 501.127 651.024 501.175 Z  M 636.215 503.124 C 635.816 503.18 635.489 503.469 635.383 503.858 L 634.868 505.792 C 634.727 506.324 635.043 506.871 635.575 507.014 C 635.661 507.036 635.749 507.047 635.837 507.046 C 636.274 507.046 636.68 506.753 636.801 506.307 L 637.321 504.374 C 637.408 504.049 637.326 503.703 637.104 503.452 C 636.881 503.2 636.548 503.077 636.215 503.124 Z  M 646.587 503.124 C 646.452 503.106 646.315 503.115 646.184 503.151 C 645.653 503.291 645.337 503.842 645.477 504.374 L 645.997 506.307 C 646.115 506.743 646.511 507.046 646.962 507.046 C 647.05 507.047 647.138 507.036 647.223 507.014 C 647.755 506.871 648.071 506.324 647.93 505.792 L 647.415 503.858 C 647.31 503.47 646.985 503.181 646.587 503.124 Z  M 641.399 503.78 C 640.844 503.78 640.399 504.225 640.399 504.78 L 640.399 506.78 C 640.399 507.335 640.844 507.78 641.399 507.78 C 641.954 507.78 642.399 507.335 642.399 506.78 L 642.399 504.78 C 642.399 504.225 641.954 503.78 641.399 503.78 Z " fill="rgb(0,0,0)"/></svg>
          </div>
        </div>
        <div class="Button" v-if="timerStarted && !timerActive" @click="resumeTimer" :key="'resume'">
          <div class="Button-icon-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="isolation:isolate" viewBox="612.399 455.78 58 58" width="58" height="58"><path d=" M 641.399 455.78 C 625.411 455.78 612.399 468.792 612.399 484.78 C 612.399 500.768 625.411 513.78 641.399 513.78 C 657.387 513.78 670.399 500.768 670.399 484.78 C 670.399 468.792 657.387 455.78 641.399 455.78 Z  M 641.399 457.78 C 656.286 457.78 668.399 469.893 668.399 484.78 C 668.399 499.667 656.286 511.78 641.399 511.78 C 626.512 511.78 614.399 499.667 614.399 484.78 C 614.399 469.893 626.512 457.78 641.399 457.78 Z  M 640.961 461.788 C 635.071 461.908 629.36 464.288 625.133 468.514 C 616.169 477.484 616.169 492.073 625.133 501.042 C 625.321 501.231 625.576 501.337 625.842 501.337 C 626.108 501.337 626.363 501.231 626.551 501.042 C 626.942 500.651 626.942 500.018 626.551 499.628 C 618.36 491.44 618.364 478.12 626.551 469.932 C 631.323 465.173 638.084 462.985 644.739 464.046 C 645.285 464.133 645.798 463.761 645.886 463.215 C 645.973 462.669 645.601 462.156 645.055 462.069 C 643.702 461.853 642.332 461.759 640.962 461.788 L 640.961 461.788 Z  M 649.059 463.167 C 648.658 463.183 648.306 463.439 648.165 463.815 C 648.071 464.064 648.08 464.34 648.19 464.582 C 648.3 464.824 648.502 465.012 648.751 465.105 C 649.461 465.37 650.165 465.675 650.852 466.018 C 650.991 466.09 651.145 466.128 651.302 466.128 C 651.665 466.128 652.016 465.928 652.196 465.577 C 652.441 465.083 652.243 464.483 651.751 464.233 C 651.002 463.857 650.234 463.52 649.45 463.225 C 649.325 463.181 649.193 463.161 649.06 463.167 L 649.059 463.167 Z  M 654.833 466.456 C 654.431 466.502 654.096 466.787 653.988 467.178 C 653.879 467.568 654.017 467.985 654.337 468.233 C 655.008 468.76 655.646 469.327 656.247 469.933 C 664.438 478.12 664.438 491.44 656.247 499.628 C 655.856 500.02 655.856 500.654 656.247 501.046 C 656.442 501.237 656.7 501.339 656.957 501.339 C 657.212 501.339 657.469 501.237 657.665 501.046 C 666.629 492.076 666.629 477.483 657.665 468.514 C 657.004 467.856 656.304 467.236 655.571 466.659 C 655.361 466.497 655.096 466.424 654.833 466.456 Z  M 636.383 473.542 C 636.029 473.538 635.679 473.63 635.372 473.807 C 634.742 474.158 634.354 474.825 634.36 475.546 L 634.36 494.014 C 634.36 494.744 634.739 495.397 635.372 495.757 C 635.999 496.112 636.769 496.103 637.387 495.733 L 652.809 486.5 C 653.419 486.133 653.786 485.492 653.786 484.781 C 653.786 484.074 653.419 483.429 652.809 483.062 L 637.387 473.828 C 637.083 473.647 636.737 473.548 636.383 473.543 L 636.383 473.542 Z  M 636.363 475.546 L 651.787 484.78 L 636.365 494.018 L 636.363 475.546 Z  M 631.774 501.175 C 631.376 501.124 630.985 501.318 630.786 501.667 L 629.786 503.397 C 629.653 503.626 629.616 503.899 629.684 504.156 C 629.753 504.412 629.92 504.631 630.149 504.764 C 630.627 505.038 631.237 504.874 631.512 504.397 L 632.512 502.667 C 632.681 502.377 632.693 502.023 632.544 501.723 C 632.396 501.422 632.106 501.217 631.774 501.175 Z  M 651.024 501.175 C 650.692 501.218 650.403 501.425 650.255 501.725 C 650.106 502.026 650.118 502.381 650.286 502.671 L 651.286 504.401 C 651.418 504.63 651.636 504.797 651.892 504.866 C 652.148 504.934 652.42 504.897 652.649 504.764 C 652.879 504.632 653.046 504.414 653.114 504.158 C 653.182 503.902 653.146 503.629 653.012 503.401 L 652.012 501.671 C 651.812 501.322 651.423 501.127 651.024 501.175 Z  M 636.215 503.124 C 635.816 503.18 635.489 503.469 635.383 503.858 L 634.868 505.792 C 634.727 506.324 635.043 506.871 635.575 507.014 C 635.661 507.036 635.749 507.047 635.837 507.046 C 636.274 507.046 636.68 506.753 636.801 506.307 L 637.321 504.374 C 637.408 504.049 637.326 503.703 637.104 503.452 C 636.881 503.2 636.548 503.077 636.215 503.124 Z  M 646.587 503.124 C 646.452 503.106 646.315 503.115 646.184 503.151 C 645.653 503.291 645.337 503.842 645.477 504.374 L 645.997 506.307 C 646.115 506.743 646.511 507.046 646.962 507.046 C 647.05 507.047 647.138 507.036 647.223 507.014 C 647.755 506.871 648.071 506.324 647.93 505.792 L 647.415 503.858 C 647.31 503.47 646.985 503.181 646.587 503.124 Z  M 641.399 503.78 C 640.844 503.78 640.399 504.225 640.399 504.78 L 640.399 506.78 C 640.399 507.335 640.844 507.78 641.399 507.78 C 641.954 507.78 642.399 507.335 642.399 506.78 L 642.399 504.78 C 642.399 504.225 641.954 503.78 641.399 503.78 Z " fill="rgb(0,0,0)"/></svg>
          </div>
        </div>
        <div class="Button" v-else-if="timerStarted && timerActive" @click="pauseTimer" :key="'pause'">
          <div class="Button-icon-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="isolation:isolate" viewBox="262.792 502.707 58 58" width="58" height="58"><path d=" M 291.792 502.707 C 275.8 502.707 262.792 515.719 262.792 531.707 C 262.792 547.695 275.8 560.707 291.792 560.707 C 307.784 560.707 320.792 547.695 320.792 531.707 C 320.792 515.719 307.784 502.707 291.792 502.707 Z  M 291.792 504.707 C 306.679 504.707 318.792 516.82 318.792 531.707 C 318.792 546.594 306.679 558.707 291.792 558.707 C 276.905 558.707 264.792 546.594 264.792 531.707 C 264.792 516.82 276.905 504.707 291.792 504.707 Z  M 291.354 508.715 C 285.41 508.837 279.743 511.246 275.53 515.441 C 266.562 524.411 266.562 539.004 275.53 547.973 C 275.726 548.164 275.98 548.266 276.237 548.266 C 276.641 548.263 277.004 548.019 277.158 547.646 C 277.312 547.272 277.228 546.843 276.944 546.556 C 268.757 538.367 268.753 525.046 276.944 516.859 C 281.69 512.109 288.491 509.91 295.132 510.973 C 295.394 511.016 295.662 510.952 295.876 510.796 C 296.091 510.641 296.235 510.406 296.276 510.144 C 296.362 509.599 295.992 509.086 295.448 508.996 C 294.095 508.782 292.725 508.688 291.355 508.715 L 291.354 508.715 Z  M 299.452 510.094 C 299.051 510.11 298.698 510.366 298.558 510.742 C 298.464 510.991 298.473 511.267 298.583 511.509 C 298.693 511.751 298.895 511.939 299.144 512.032 C 299.854 512.292 300.558 512.602 301.241 512.945 C 301.735 513.195 302.338 512.997 302.589 512.504 C 302.834 512.01 302.635 511.411 302.144 511.16 C 301.395 510.785 300.627 510.448 299.843 510.152 C 299.718 510.108 299.585 510.088 299.453 510.094 L 299.452 510.094 Z  M 305.226 513.383 C 304.824 513.429 304.489 513.715 304.38 514.105 C 304.272 514.495 304.41 514.912 304.73 515.16 C 305.4 515.688 306.038 516.255 306.64 516.86 C 314.831 525.047 314.831 538.367 306.64 546.555 C 306.249 546.947 306.249 547.581 306.64 547.973 C 306.835 548.164 307.093 548.266 307.35 548.266 C 307.605 548.266 307.862 548.164 308.058 547.973 C 317.022 539.003 317.022 524.41 308.058 515.441 C 307.396 514.783 306.697 514.163 305.964 513.586 C 305.754 513.424 305.489 513.351 305.226 513.383 Z  M 284.792 520.707 C 283.69 520.707 282.792 521.605 282.792 522.707 L 282.792 540.707 C 282.792 541.809 283.69 542.707 284.792 542.707 L 288.792 542.707 C 289.894 542.707 290.792 541.809 290.792 540.707 L 290.792 522.707 C 290.792 521.605 289.894 520.707 288.792 520.707 L 284.792 520.707 Z  M 294.792 520.707 C 293.69 520.707 292.792 521.605 292.792 522.707 L 292.792 540.707 C 292.792 541.809 293.69 542.707 294.792 542.707 L 298.792 542.707 C 299.894 542.707 300.792 541.809 300.792 540.707 L 300.792 522.707 C 300.792 521.605 299.894 520.707 298.792 520.707 L 294.792 520.707 Z  M 284.792 522.707 L 288.792 522.707 L 288.792 540.707 L 284.792 540.707 L 284.792 522.707 Z  M 294.792 522.707 L 298.792 522.707 L 298.792 540.707 L 294.792 540.707 L 294.792 522.707 Z  M 282.167 548.102 C 281.768 548.051 281.378 548.245 281.179 548.594 L 280.179 550.324 C 280 550.632 280 551.012 280.177 551.321 C 280.355 551.63 280.684 551.821 281.04 551.821 C 281.397 551.822 281.726 551.632 281.905 551.324 L 282.905 549.594 C 283.073 549.304 283.085 548.95 282.937 548.65 C 282.788 548.349 282.499 548.144 282.167 548.102 Z  M 301.417 548.102 C 301.085 548.145 300.796 548.352 300.647 548.652 C 300.499 548.953 300.511 549.308 300.679 549.598 L 301.679 551.328 C 301.811 551.557 302.029 551.725 302.285 551.793 C 302.541 551.861 302.813 551.824 303.042 551.691 C 303.272 551.559 303.439 551.341 303.507 551.085 C 303.575 550.829 303.539 550.557 303.405 550.328 L 302.405 548.598 C 302.206 548.249 301.816 548.053 301.417 548.102 Z  M 296.979 550.051 C 296.845 550.031 296.707 550.04 296.577 550.078 C 296.046 550.218 295.73 550.769 295.87 551.301 L 296.39 553.234 C 296.508 553.67 296.903 553.973 297.355 553.973 C 297.443 553.974 297.531 553.963 297.616 553.941 C 298.147 553.797 298.464 553.25 298.323 552.719 L 297.808 550.785 C 297.703 550.397 297.378 550.108 296.98 550.051 L 296.979 550.051 Z  M 286.605 550.051 C 286.207 550.108 285.881 550.397 285.776 550.785 L 285.261 552.719 C 285.181 553.019 285.245 553.339 285.435 553.585 C 285.625 553.831 285.918 553.974 286.229 553.973 C 286.667 553.973 287.073 553.68 287.194 553.234 L 287.71 551.301 C 287.779 551.046 287.744 550.773 287.612 550.544 C 287.48 550.314 287.263 550.147 287.007 550.078 C 286.876 550.042 286.739 550.033 286.605 550.051 Z  M 291.792 550.707 C 291.24 550.707 290.792 551.155 290.792 551.707 L 290.792 553.707 C 290.792 554.259 291.24 554.707 291.792 554.707 C 292.344 554.707 292.792 554.259 292.792 553.707 L 292.792 551.707 C 292.792 551.155 292.344 550.707 291.792 550.707 Z " fill="rgb(0,0,0)"/></svg>
          </div>
        </div>
      </transition>
    </section>

    <app-timer-footer/>
    <app-timer-controller/>
  </div>
</template>

<script>
import Timer from '@/utils/timer'
import appAudio from '@/components/Audio'
import appTimerController from '@/components/timer/Timer-controller'
import appTimerDial from '@/components/timer/Timer-dial'
import appTimerFooter from '@/components/timer/Timer-footer'
import { EventBus } from '@/utils/event-bus'

export default {
  components: {
    appAudio,
    appTimerController,
    appTimerDial,
    appTimerFooter
  },

  data () {
    return {
      minutes: 1,
      timer: null,
      timerActive: false,
      timerStarted: false
    }
  },

  computed: {
    // store getters
    currentRound () {
      return this.$store.getters.currentRound
    },

    timeLongBreak () {
      return this.$store.getters.timeLongBreak
    },

    timeShortBreak () {
      return this.$store.getters.timeShortBreak
    },

    timeWork () {
      return this.$store.getters.timeWork
    },

    // local
    prettyMinutes () {
      return this.minutes + ':00'
    },

    prettyTime () {
      return `${this.timeRemaining.remainingMinutes}:${this.timeRemaining.remainingSeconds}`
    },

    timeElapsed () {
      if (this.timer.time !== null) {
        const time = this.timer.time
        const minutes = Math.floor(time / 60)
        const seconds = time - (minutes * 60)
        return {
          minutes,
          seconds
        }
      }
    },

    timeRemaining () {
      if (this.timer.time !== null) {
        const minutes = this.minutes
        const time = this.timer.time
        const elapsedMinutes = Math.floor(time / 60)
        const elapsedSeconds = time - (elapsedMinutes * 60)
        const remainingSeconds = this.formatTimeDouble(60 - elapsedSeconds)
        let remainingMinutes = minutes - elapsedMinutes

        if (elapsedSeconds > 0) {
          remainingMinutes -= 1
        }

        return {
          remainingMinutes,
          remainingSeconds
        }
      }
    }
  },

  methods: {
    formatTimeDouble (time) {
      if (time === 60) {
        return '00'
      } else if (time < 10) {
        return `0${time}`
      } else {
        return time
      }
    },

    createTimer (min) {
      this.timer = new Timer(min)
    },

    initTimer () {
      switch (this.currentRound) {
        case 'work':
          this.minutes = this.timeWork
          this.createTimer(this.timeWork)
          break
        case 'short-break':
          this.minutes = this.timeShortBreak
          this.createTimer(this.timeShortBreak)
          break
        case 'long-break':
          this.minutes = this.timeLongBreak
          this.createTimer(this.timeLongBreak)
          break
        default:
          this.createTimer(25)
          break
      }
    },

    pauseTimer () {
      this.timer.pause()
      this.timerActive = !this.timerActive
    },

    resetTimer () {
      this.timer.reset()
      this.timerActive = !this.timerActive
      this.timerStarted = false
    },

    resumeTimer () {
      this.timer.resume()
      this.timerActive = true
    },

    startTimer () {
      this.timer.start()
      this.timerActive = true
      this.timerStarted = true
    }
  },

  mounted () {
    this.initTimer()

    EventBus.$on('timer-init', opts => {
      // clear previous timers
      this.timer.reset()
      this.initTimer()
      if (opts.auto) {
        setTimeout(() => {
          this.startTimer()
        }, 1500)
      } else {
        this.timerActive = false
      }
    })

    EventBus.$on('call-timer-reset', () => {
      this.resetTimer()
    })
  }
}
</script>

<style lang="scss" scoped>
.Button {
  border-radius: 100%;
  display: flex;
  cursor: pointer;
  justify-content: center;
  transition: $transitionDefault;
  width: 50px;
  height: 50px;
  -webkit-app-region: no-drag;
  svg {
    width: 52px;
    path {
      fill: darken($colorBlueGrey, 10%);
    }
  }
  &:hover {
    & .Icon--pause line {
      stroke: $colorRed;
    }
    & .Icon--start polygon {
      fill: $colorRed;
    }
    & svg path {
      fill: $colorBlueGrey;
    }
  }
}

.Button-wrapper {
  display: flex;
  justify-content: center;
  margin: 20px 0 10px 0;
}

.Button-icon-wrapper {
  align-items: center;
  display: flex;
  height: 100%;
}

.Dial-time {
  font-family: 'RobotoMono', monospace;
  font-size: 40px;
  margin: 0;
  color: lighten($colorBlueGrey, 20%);
  position: absolute;
  top: calc(50% - 26px);
}

.Timer-wrapper {
  display: flex;
  flex-direction: column;
}
</style>
